<dom-module id="login-helper">
  <style>
  paper-button.colored {
    background: var(--default-primary-color);
    color: var(--text-primary-color);
  }

  paper-dialog {
    background: var(--default-dialog-background-color);
  }

  paper-spinner {
    position: absolute;
    right: 30px;
  }
  </style>
  <template>

    <paper-input id="email_input" label="Email" type="email" value="{{email}}"></paper-input>
    <iron-a11y-keys id="email_enter_handler" keys="enter" on-keys-pressed="loginTap"></iron-a11y-keys>
    <paper-input id="password_input" label="Password" type="password" value="{{password}}"></paper-input>
    <iron-a11y-keys id="password_enter_handler" keys="enter" on-keys-pressed="loginTap"></iron-a11y-keys>
    <br>
    <paper-button id="login_button" on-tap="loginTap" raised disabled>Login</paper-button>
    <paper-spinner id="login_spinner" active></paper-spinner>

    <spark-controller id="spark_controller"
      on-response='loginSuccess'
      on-error='loginFailure'>
    </spark-controller>

    <paper-dialog id="error_dialog" modal="true">
      <h2>Error</h2>
      <paper-dialog-scrollable>{{errorMessage}}</paper-dialog-scrollable>
      <div class="buttons">
        <paper-button dialog-dismiss>Ok</paper-button>
      </div>
    </paper-dialog>

  </template>

  <script>
    (function() {
      Polymer({
        is: 'login-helper',

        ready: function(){
          this.$.email_enter_handler.target = this.$.email_input
          this.$.password_enter_handler.target = this.$.password_input;
          this.$.login_spinner.toggleAttribute("active", false);
        },

        properties : {
          email : {
            type: String,
            value: "",
            observer: 'inputChange'
          },
          password : {
            type: String,
            value: "",
            observer: 'inputChange'
          },
          errorMessage : {
            type: String,
            value: ""
          },

          transitionPage : {
            type: String
          }
        },

        inputChange: function(){
          if(this.email != "" && this.password != ""){
            var loginButton = this.$.login_button;
            loginButton.toggleAttribute("disabled", false);
            loginButton.toggleClass("colored", true);
          }else{
            var loginButton = this.$.login_button;
            loginButton.toggleAttribute("disabled", true);
            loginButton.toggleClass("colored", false);
          }
        },

        loginSuccess: function(e){
          app.token = e.detail.response.access_token;
          this.$.login_spinner.toggleAttribute("active", false);
          page(this.transitionPage);
        },

        loginFailure: function(e){
          this.errorMessage = e.detail.request.xhr.response.error_description;
          this.$.login_spinner.toggleAttribute("active",false);
          this.$.error_dialog.toggle();
        },

        loginTap: function(){
          if(this.email != "" && this.password != ""){
            this.$.login_spinner.toggleAttribute("active", true);
            this.$.spark_controller.getAccessToken(
              {username : this.email, password: this.password},
              this.loginSuccess, this.loginFailure);
          }
        }
      });
    })();
  </script>
</dom-module>
